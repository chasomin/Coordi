//
//  NetworkManager.swift
//  Coordi
//
//  Created by Ï∞®ÏÜåÎØº on 4/15/24.
//

import Foundation
import Alamofire
import RxSwift

final class API {
    static let session: Session = {
        let configuration = URLSessionConfiguration.af.default
        let apiLogger = APIMonitor.shared
        return Session(configuration: configuration, eventMonitors: [apiLogger])
    }()
}

struct NetworkManager {
    
    static func request<T: Decodable>(api: Router) -> Single<T> {
        return Single<T>.create { single in
            do {
                let urlRequest = try api.asURLRequest()
                
                API.session.request(urlRequest, interceptor: TokenRefresh())
                    .responseDecodable(of: T.self) { response in
                        switch response.result {
                        case .success(let success):
                            single(.success(success))
                            dump(success)
                        case .failure(_):
                            print("üëªÏó¨Í∏∞!@!@!@")
                            guard let statusCode = response.response?.statusCode else { return }
                            switch statusCode {
                            case 400:
                                single(.failure(CoordiError.invalidRequest(kind: api)))
                            case 401:
                                single(.failure(CoordiError.unauthenticatedToken(kind: api)))
                            case 403:
                                single(.failure(CoordiError.forbidden))
                            case 409:
                                single(.failure(CoordiError.alreadySubscribed))
                            case 410:
                                single(.failure(CoordiError.creationFailed))
                            case 418:
                                single(.failure(CoordiError.refreshTokenExpired))
                            case 419:
                                single(.failure(CoordiError.accessTokenExpired))
                            case 420:
                                single(.failure(CoordiError.withoutKey))
                            case 429:
                                single(.failure(CoordiError.overCall))
                            case 444:
                                single(.failure(CoordiError.invalidURL))
                            case 445:
                                single(.failure(CoordiError.haveNoAuthority))
                            case 500:
                                single(.failure(CoordiError.unknownError))
                            default:
                                single(.failure(CoordiError.unknownError))
                            }
                            print("üëªÏó¨Í∏∞!@!@!@", statusCode)

                        }
                    }
            } catch {
            }
            return Disposables.create()
        }
    }
    
    static func request(api: Router) -> Single<Bool> {
        return Single<Bool>.create { single in
            do {
                let urlRequest = try api.asURLRequest()
                
                API.session.request(urlRequest, interceptor: TokenRefresh())
                    .response(completionHandler: { response in
                        switch response.result {
                        case .success(_):
                            single(.success(true))
                        case .failure(_):
                            print("üëªÏó¨Í∏∞!@!@!@")
                            guard let statusCode = response.response?.statusCode else { return }
                            switch statusCode {
                            case 400:
                                single(.failure(CoordiError.invalidRequest(kind: api)))
                            case 401:
                                single(.failure(CoordiError.unauthenticatedToken(kind: api)))
                            case 403:
                                single(.failure(CoordiError.forbidden))
                            case 409:
                                single(.failure(CoordiError.alreadySubscribed))
                            case 410:
                                single(.failure(CoordiError.creationFailed))
                            case 418:
                                single(.failure(CoordiError.refreshTokenExpired))
                            case 419:
                                single(.failure(CoordiError.accessTokenExpired))
                            case 420:
                                single(.failure(CoordiError.withoutKey))
                            case 429:
                                single(.failure(CoordiError.overCall))
                            case 444:
                                single(.failure(CoordiError.invalidURL))
                            case 445:
                                single(.failure(CoordiError.haveNoAuthority))
                            case 500:
                                single(.failure(CoordiError.unknownError))
                            default:
                                single(.failure(CoordiError.unknownError))
                            }
                            print("üëªÏó¨Í∏∞!@!@!@", statusCode)

                        }
                    })
            } catch {
            }
            return Disposables.create()
        }
    }

    static func upload<T: Decodable>(api: Router) -> Single<T> {
        return Single<T>.create { single in
            guard let url = URL(string: api.baseURL + api.path) else { return Disposables.create() }
            let accessToken = UserDefaultsManager.accessToken
            print(url)
            let headers: HTTPHeaders = [
                HTTPHeader.sesacKey.rawValue: APIKey.key.rawValue,
                HTTPHeader.contentType.rawValue: HTTPHeader.multi.rawValue,
                HTTPHeader.authorization.rawValue: accessToken
            ]
            guard let parameters = api.parameters else { return Disposables.create() }
            
            API.session.upload(multipartFormData: { multipartFormData in
                
                for (key, value) in parameters {
                    if value is [Data] {
                        for image in value as! [Data] {
                            multipartFormData.append(image,
                                                     withName: key,
                                                     fileName: "Coordi.jpg",
                                                     mimeType: "image/jpeg")
                        }
                    } else if value is Data {
                        multipartFormData.append(value as! Data,
                                                 withName: key,
                                                 fileName: "Coordi.jpg",
                                                 mimeType: "image/jpeg")
                    } else {
                        multipartFormData.append("\(value)".data(using: .utf8)!, withName: key)
                    }
                }
                
            }, to: url, method: api.method, headers: headers)
            .responseDecodable(of: T.self) { response in
                switch response.result {
                case .success(let success):
                    single(.success(success))
                    dump(success)
                    
                case .failure(_):
                    guard let statusCode = response.response?.statusCode else { return }
                    switch statusCode {
                    case 400:
                        single(.failure(CoordiError.invalidRequest(kind: api)))
                    case 401:
                        single(.failure(CoordiError.unauthenticatedToken(kind: api)))
                    case 403:
                        single(.failure(CoordiError.forbidden))
                    case 409:
                        single(.failure(CoordiError.alreadySubscribed))
                    case 410:
                        single(.failure(CoordiError.creationFailed))
                    case 418:
                        single(.failure(CoordiError.refreshTokenExpired))
                    case 419:
                        single(.failure(CoordiError.accessTokenExpired))
                    case 420:
                        single(.failure(CoordiError.withoutKey))
                    case 429:
                        single(.failure(CoordiError.overCall))
                    case 444:
                        single(.failure(CoordiError.invalidURL))
                    case 445:
                        single(.failure(CoordiError.haveNoAuthority))
                    case 500:
                        single(.failure(CoordiError.unknownError))
                    default:
                        single(.failure(CoordiError.unknownError))
                    }
                }
            }
            return Disposables.create()
        }
    }
}


enum CoordiError: Error {
    case withoutKey
    case invalidRequest(kind: Router)
    case unauthenticatedToken(kind: Router)
    case forbidden
    case alreadySubscribed
    case creationFailed
    case refreshTokenExpired
    case accessTokenExpired
    case overCall
    case invalidURL
    case haveNoAuthority
    case unknownError
    
    var errorMessage: String {
        switch self {
        case .withoutKey:                       // 420
            "SeSAC Memolease Only"
        case .invalidRequest(let kind):         // 400
            switch kind {
            case .signUp, .emailValidation, .logIn:
                "ÌïÑÏàò Í∞íÏùÑ Ï±ÑÏõåÏ£ºÏÑ∏Ïöî"
            case .uploadImage, .editProfileImage:
                "5MB ÎØ∏Îßå Ïù¥ÎØ∏ÏßÄÎßå Í∞ÄÎä•Ìï¥Ïöî"
            case .uploadComment, .editComment:
                "ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ Ï±ÑÏõåÏ£ºÏÑ∏Ïöî"
            case .like, .follow, .hashtag, .fetchPost, .fetchParticularPost, .fetchPostByUser, .fetchLikePost:
                "ÏûòÎ™ªÎêú ÏöîÏ≤≠Ïù¥ÏóêÏöî"
            case .paymentValid:
                "Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Í≤∞Ï†úÍ±¥ÏûÖÎãàÎã§"
            default:
                ""
            }
        case .unauthenticatedToken(let kind):   // 401
            switch kind {
            case .logIn:
                "Í≥ÑÏ†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            default:
                "Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî"
            }
        case .forbidden:                        // 403
            "Ï†ëÍ∑ºÍ∂åÌïúÏù¥ ÏóÜÏñ¥Ïöî"
        case .alreadySubscribed:                // 409
            "Ïù¥ÎØ∏ Í∞ÄÏûÖÎêú Í≥ÑÏ†ïÏù¥ÏóêÏöî"
        case .creationFailed:                   // 410, Ï†ÄÏû•ÏàòÏ†ïÏÇ≠Ï†ú
            "ÏÉùÏÑ± Ïã§Ìå®"
        case .refreshTokenExpired:              // 418
            "Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî"
        case .accessTokenExpired:               // 419
            "accessToken ÎßåÎ£å"
        case .overCall:                         // 429
            "Ïû†ÏãúÌõÑÏóê Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî"
        case .invalidURL:                       // 444
            "ÎπÑÏ†ïÏÉÅ URL"
        case .haveNoAuthority:                  // 445
            "Îã§Î•∏ ÏÇ¨Ïö©Ïûê Í∏ÄÏùÄ Ï†ëÍ∑ºÍ∂åÌïúÏù¥ ÏóÜÏñ¥Ïöî"
        case .unknownError:                     // 500
            "Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî"
        }
    }
}
